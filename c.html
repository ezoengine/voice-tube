<html>
	<head>
		<script src="bower_components/platform/platform.js"></script>
		<link rel='stylesheet' href="a.css">
		<link rel="import" href="elements/user-card.html">
		<link rel="import" href="elements/video-card.html">
		<link rel="import" href="elements/voice-tube.html">
		<script src="elements/jquery-2.1.1.min.js"></script>
		<script src="https://cdn.firebase.com/js/client/1.1.3/firebase.js"></script>
	</head>
	<body style="background-color:#000;color:#fff;height:100%;">
	<div vertical layout center-justified>

		<div id='cards' vertical layout center-justified flex>
			<div layout horizontal center-justified>
			<user-card name='Marty' today='432' total='700' >
				<img src="https://lh3.googleusercontent.com/jIWmpd9rz0CdGrrds9vqg1pMN2TG4lW5Og2Ir-qH4Ymo=s422-p-no">
			</user-card>
			<user-card name='NaNa' today='432' total='1999' >
				<img src="https://lh4.googleusercontent.com/-IzSLR5AY4w4/U9NSsZeY5AI/AAAAAAABahQ/EIiLkWIpM0I/w1108-h1476-no/IMG_20140726_150217.jpg">
			</user-card>
			<user-card name='NiNa' today='432' total='999' >
				<img src="https://lh6.googleusercontent.com/NKSNP_VEHA4SFj3KIvaN1wS-ptkXIliyKmO-IdAMKNdk=s422-p-no">
			</user-card>
			<user-card name='Lynn' today='432' total='9999' >
				<img src="https://lh4.googleusercontent.com/_HQc9_t-fxtk2vwcIgfYF-svp6w7xt_DJENRRE8nNXIi=s422-p-no">
			</user-card>
			</div>
		</div>

		<div id='videos' vertical layout center-justified style="height:100%;">
			<div layout horizontal center-justified>
			<video-card name='The Power to Create' vid='17821' youtubeid='lZgjpuFGb_8'>
			</video-card>
			<video-card name='《Hello!kids》第1課' vid='9947' youtubeid='q1VN-UxoN6U'>
			</video-card>
			<video-card name='《Hello!kids》第2課' vid='10294' youtubeid='ciobzXmWppY'>
			</video-card>
			</div>
		</div>


		<div id='showtime'>
			<div id='board' style="display:none;position:absolute;right:0">
				<div vertical layout end style="color:#faa;font: 120px/1.3 'Crafty Girls';height:200px;">
				<div id='score' style="width:300px;text-align:center"></div>
				<div style="width:300px;text-align:center;margin:-60px 0 0 0">=</div>
				</div>
			</div>
			<div id='ctx' style='margin:0 100px 0 100px'>
				
			</div>
			<div style='font-size:0.5em'>
				<div id='sc'></div>
				<div id='result'></div>
				<div id='speak'></div>
			</div>
		</div>

	</div>
		<script>
			var study = {};
			var username = '';
			var db = new Firebase("https://voice-tube.firebaseio.com/");

			addEventListener('user-card-click',function(e){
				username = e.detail;
				$('#cards').fadeOut(function(){
					$('#videos').fadeIn();
				});
			});

			addEventListener('video-card-click',function(e){
				study = e.detail;
				study.exam = '1..5';
				$('#videos').fadeOut(function(){
					insertVoiceTube(study.vid,study.youtubeid,study.exam);
					$('#showtime').fadeIn();
					console.log('username',username);
					console.log('study',study);
				});
			});

			addEventListener('x-sentence-completed',function(e){
				updateSentence(e.detail.val);
			});

			addEventListener('voice-tube-ready',function(e){
				//clearDB();
				v.focus();
			});

			addEventListener('voice-tube-completed',function(e){
				var i = e.detail;
				board.style.display = 'block';
				document.querySelector('#score').innerHTML = i.score;
				document.querySelector('#sc').innerHTML = i.score;
				document.querySelector('#result').innerHTML = '花費時間:' + i.spendTime;
				document.querySelector('#speak').innerHTML = '聆聽次數:' + i.speakTimes;
			});

			function clearDB(){
				var sentList = v.info();
				var initObj = {};
				initObj[username] = {};
				initObj[username][study.youtubeid] = {vid:study.vid};
				db.set(initObj);
				console.log('clearDB',initObj);
			}

			function updateSentence(sentObj){
				var saveObj = {};
				var sentences = db.child(username+"/"+study.youtubeid+"/sentences");
				sentences.once('value',function(obj){
					if(obj.val() != null){
						saveObj = obj.val();
					}
					qq = saveObj;

					var key = 'idx'+(sentObj.idx<10? '0':'')+sentObj.idx;
					if(!saveObj.hasOwnProperty(key)){
						saveObj[key] = [];
					}
					var info = sentObj.info();
					delete info.sentence;
					saveObj[key].push(info);
					sentences.update(saveObj);
				});				
			}

			function insertVoiceTube(vid,youtubeid,exam){
				document.querySelector('#ctx').innerHTML = 
				"<voice-tube id='v' vid='"+vid+
				"' youtubeid='"+youtubeid+
				"' exam='"+exam+
				"' size='24'></voice-tube>";
			}

		</script>
	</body>
</html>

