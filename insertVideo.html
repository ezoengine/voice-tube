<html>

<head>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono">
    <style>
    body {
        font: 'Droid Sans Mono', sans-serif;
    }
    </style>
    <script src="bower_components/platform/platform.js"></script>
    <link rel='stylesheet' href="a.css">
    <script src="elements/jquery-2.1.1.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/1.1.3/firebase.js"></script>
    <script src="jsUtils.js"></script>
</head>

<body style="font-size:1em;background-color:#000;color:#fff">
    name:
    <input type='txt' id='name' value="" style="font-size:2em">
    <br>
    <br>srt_name:
    <input type='txt' id='vid' value='' style="font-size:2em">
    <br>
    <br>youtubeid:
    <input type='txt' id='youtubeid' value='' style="font-size:2em">
    <br>
    <br>
    <button style='font-size:2em' onclick='main()'>Send</button>

    <div id='ctx'></div>
    <script>
    var cdn = new Firebase("https://voice-tube-cdn.firebaseio.com/");

    // to get really youtubeID
    $('#youtubeid').on('keyup', function(e) {
        var val = $(this).val();
        var pos = val.indexOf('?v=');
        if (pos > 0) {
            val = val.substring(pos + 3);
            $(this).val(val);
        }
    });

    function main() {
        var youtubeid = $('#youtubeid').val(),
            vid = $('#vid').val(),
            name = $('#name').val();
        if (isNaN(vid)) {
            getSrtChinese(vid, function(data) {
                upload(name, youtubeid, vid, data);
            });
        } else {
            getVideo(vid, function(video) {
                video['info'] = {
                    name: name,
                    youtubeid: youtubeid,
                    vid: vid
                };
                upload2Firebase(vid, video);
            });
        }
    }

    function toSec(time) {
        time = time.replace(/,/, '.').split(':');
        var sec = parseInt(time[0]) * 60 * 60 + parseInt(time[1]) * 60 + (time[2] * 1.0);
        return parseInt(sec * 1000) / 1000.0;
    }

    function parseTimeInfo(info) {
        info = info.split(' --> ');
        var stTime = toSec(info[0]);
        var edTime = toSec(info[1]);
        var dur = parseInt(parseInt((edTime - stTime) * 1000)) / 1000.0;
        return [stTime, dur];
    }

    function getSrtChinese(vid, callback) {
        var url = "https://www.hopenglish.com/audio_file/play/" + vid + "/read/cht.txt";
        $.ajax(url).always(function(e) {
            var srt = typeof e === 'string' ? e.split('\r\n') : '';
            var srtInfo = {};
            for (var i = 0; i < srt.length; i++) {
                var info = srt[i].split('# ');
                srtInfo['' + parseInt(info[0])] = info[1];
            }
            callback(srtInfo);
        });
    }


    function upload(name, youtubeid, vid, srt_chinese) {
        $.ajax({
            type: "POST",
            url: "https://www.hopenglish.com/ajax/render_course_subtitle",
            data: {
                srt_name: vid
            },
            dataType: 'json',
            success: function(data) {
                var video = {
                    'en': [],
                    'zh-Hant': []
                };
                for (var i = 0; i < data.length; i = i + 3) {
                    var timeInfo = parseTimeInfo(data[i + 1]);
                    var startTime = timeInfo[0];
                    var durTime = timeInfo[1];
                    var key = i / 3;
                    video.en.push({
                        seq: key + 1,
                        start: startTime,
                        dur: durTime,
                        text: data[i + 2]
                    });
                    video['zh-Hant'].push({
                        seq: key + 1,
                        start: startTime,
                        dur: durTime,
                        text: srt_chinese[key + 1]
                    });
                }
                video['info'] = {
                    name: name,
                    youtubeid: youtubeid,
                    vid: vid
                };
                upload2Firebase(vid, video);
            }
        });
    };

    function upload2Firebase(vid, captions) {
        var obj = {};
        obj[vid] = captions;
        console.log('upload to firebase, name:', vid);
        cdn.child("videos").update(obj, function() {
        	var str = JSON.stringify(captions);
        	$('#ctx').html(str);
        });
    }

    function getVideo(vid, doneCallback) {
        $.ajax({
                dataType: 'jsonp',
                url: 'http://cdn.voicetube.tw/assets/captions/' + vid + '.js'
            })
            .always(function() {
                var obj = {};
                obj[vid] = captions;
                if (typeof doneCallback === 'function') {
                    doneCallback(captions);
                }
            });
    }
    </script>
</body>

</html>