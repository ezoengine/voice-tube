<html>
	<head>
		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono">
		<style>body{font: 32px/1.3 'Droid Sans Mono', sans-serif;}</style>
		<script src="bower_components/platform/platform.js"></script>
		<link rel="import" href="elements/voice-tube.html">
		<script src="https://cdn.firebase.com/js/client/1.1.3/firebase.js"></script>
	</head>
	<body style="background-color:#000;color:#fff">
		<div id='board' style="display:none;position:absolute;right:0">
			<div vertical layout end style="color:#faa;font: 120px/1.3 'Crafty Girls';height:200px;">
			<div id='score' style="width:300px;text-align:center"></div>
			<div style="width:300px;text-align:center;margin:-60px 0 0 0">=</div>
			</div>
		</div>
		<div id='ctx'>
			
		</div>
		<div style='font-size:0.5em'>
			<div id='sc'></div>
			<div id='result'></div>
			<div id='speak'></div>
		</div>

		<script>
			var db = new Firebase("https://voice-tube.firebaseio.com/");
			var username = 'marty';
			var study = {
				vid: '17821',
				youtubeid: 'lZgjpuFGb_8',
				exam: window.location.hash.substring(1)
			};

			insertVoiceTube(study.vid,study.youtubeid,study.exam);

			addEventListener('x-sentence-completed',function(e){
				updateSentence(e.detail.val);
			});

			addEventListener('voice-tube-ready',function(e){
				//clearDB();
				v.focus();
			});

			addEventListener('voice-tube-completed',function(e){
				var i = e.detail;
				board.style.display = 'block';
				document.querySelector('#score').innerHTML = i.score;
				document.querySelector('#sc').innerHTML = i.score;
				document.querySelector('#result').innerHTML = '花費時間:' + i.spendTime;
				document.querySelector('#speak').innerHTML = '聆聽次數:' + i.speakTimes;
			});

			function clearDB(){
				var sentList = v.info();
				var initObj = {};
				initObj[username] = {};
				initObj[username][study.youtubeid] = {vid:study.vid};
				db.set(initObj);
				console.log('clearDB',initObj);
			}

			function updateSentence(sentObj){
				var saveObj = {};
				var sentences = db.child(username+"/"+study.youtubeid+"/sentences");
				sentences.once('value',function(obj){
					if(obj.val() != null){
						saveObj = obj.val();
					}
					qq = saveObj;

					var key = 'idx'+(sentObj.idx<10? '0':'')+sentObj.idx;
					if(!saveObj.hasOwnProperty(key)){
						saveObj[key] = [];
					}
					var info = sentObj.info();
					delete info.sentence;
					saveObj[key].push(info);
					sentences.update(saveObj);
				});				
			}

			function insertVoiceTube(vid,youtubeid,exam){
				document.querySelector('#ctx').innerHTML = 
				"<voice-tube id='v' vid='"+vid+
				"' youtubeid='"+youtubeid+
				"' exam='"+exam+
				"' size='24'></voice-tube>";
			}

		</script>
	</body>
</html>

