<html>

<head>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono">
    <style>
    body {
        min-width: 960px;
        min-height: 640px;
        font: 'Droid Sans Mono', sans-serif;
    }
    </style>
    <link rel='stylesheet' href="a.css">
    <script src='bower_components/webcomponentsjs/webcomponents.js'></script>
    <link rel="import" href="elements/user-card-list.html">
    <link rel="import" href="elements/video-card-list.html">
    <link rel="import" href="elements/voice-tube.html">
    <link rel="import" href="elements/user-status.html">
    <link rel="import" href="elements/data-base.html">
    <link rel="import" href="elements/range-slider.html">
    <script src="jsUtils.js"></script>
</head>

<body class='fontstyle' unresolved fullbleed>

    <div id='cards' vertical layout center-justified>
        <user-card-list id='uclist'></user-card-list>
        <br>
        <c3-timeseries id='c3t' width='60%'></c3-timeseries>
    </div>

    <div id='videos'>
        <h1>Video List</h1>
        <div style='text-align:center;margin:80px'>
            <video-card-list id='vclist'>
            </video-card-list>
        </div>
    </div>


    <div id='selectRange' style='margin:0 auto;'>
        <user-status id='userStatus' style="font-size:1.2em;"></user-status>

        <div layout horizontal style='font-size:2em;width:600px;margin-top:50px' center>
            <div id='rrr' flex></div>    
        </div>
        <div style='width:600px;text-align:center'>
            <button id='go' style='width:80%;height:100px;font-size:4em;margin:100px auto'>Go</button>
        </div>
    </div>

    <div id='showtime'>
        <div id='board' style="display:none;position:absolute;right:0">
            <div vertical layout end style="color:#faa;font: 120px/1.3 'Crafty Girls';height:200px;">
                <div id='score' style="width:300px;text-align:center"></div>
                <div style="width:300px;text-align:center;margin:-60px 0 0 0">=</div>
            </div>
        </div>
        <button onclick="showExam()">Start</button>
        <div id='ctx' style='margin:0 100px 0 100px'></div>
        <div style='font-size:0.5em'>
            <div id='sc'></div>
            <div id='result'></div>
            <div id='speak'></div>
        </div>
    </div>
    <data-base id='video' url="https://voice-tube-cdn.firebaseio.com/videos">
        <script>
        function showUserChart(user) {
            window.user = user;
            var info = user.studyHistory();
            var columns = [
                [],
                ['time(min)'],
                ['sentence']
            ]
            for (var key in info) {
                columns[0].push(key);
                var min = parseInt(info[key].spendTime / 60);
                columns[1].push(min);
                columns[2].push(info[key].sentenceAmt);
            }
            c3t.render(columns);
        }

        //window.onbeforeunload = function() { return "You work will be lost."; };
        //c3t.columns = '[["2013/01/01", "2013/01/02"],["data1", 30, 200],["data2", 310, 100]]'


        go.addEventListener('click', function(e) {
            var range = {
                start: rs.minval,
                end: rs.maxval
            };
            localStorage.setItem('selectRange', JSON.stringify(range));
            $('#selectRange').fadeOut(function() {
                user.range = range;
                showExam();
            });
        });

        function showExam() {
            video.query(user.study.vid, function(captions) {
                localStorage.setItem(user.study.vid, JSON.stringify(captions));
                document.querySelector('#ctx').innerHTML =
                    "<voice-tube id='v' vid='" + user.study.vid +
                    "' youtubeid='" + user.study.youtubeid +
                    "' exam='" + user.range.start + '..' + user.range.end +
                    "' size='32'></voice-tube>";
            });
            $('#showtime').fadeIn();
        }

        addEventListener('user-card-click', function(e) {
            $('#cards').fadeOut(function() {
                $('#videos').fadeIn();
            });
        });

        addEventListener('user-card-onHovered', function(e) {
            var user = e.detail;
            showUserChart(user);
        });

        addEventListener('video-card-click', function(e) {
            user.study = e.detail;
            $('#videos').fadeOut(function() {
                $('#selectRange').fadeIn();
                info = user.videoInfo();
                userStatus.info(info);
                userStatus.renderChart(user);
                //
                rrr.innerHTML = "<range-slider id='rs'></range-slider>";
                var range = localStorage.getItem('selectRange');
                if (range != null) {
                    range = JSON.parse(range);
                    rs.minval = range.start;
                    rs.maxval = range.end;
                }
            });
        });

        addEventListener('x-sentence-completed', function(e) {
            var sentObj = e.detail.val;
            user.updateSentence(sentObj);
        });

        addEventListener('voice-tube-ready', function(e) {
            v.focus();
        });

        addEventListener('voice-tube-completed', function(e) {
            var i = e.detail;
            board.style.display = 'block';
            document.querySelector('#score').innerHTML = i.score;
            document.querySelector('#sc').innerHTML = i.score;
            document.querySelector('#result').innerHTML = '花費時間:' + i.spendTime;
            document.querySelector('#speak').innerHTML = '聆聽次數:' + i.speakTimes;
        });



        </script>
</body>

</html>